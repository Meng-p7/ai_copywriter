<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ‹</title>
    <style>
        :root {
            --primary: #FF8C38; /* æš–æ©™ä¸»è‰² */
            --primary-light: #FFE0C0; /* æµ…æ©™èƒŒæ™¯ */
            --primary-dark: #E67320; /* æ·±æ©™hover */
            --text-main: #333333; /* ä¸»æ–‡æœ¬ */
            --text-secondary: #666666; /* æ¬¡æ–‡æœ¬ */
            --text-hint: #999999; /* æç¤ºæ–‡æœ¬ */
            --border: #F0D0B0; /* è¾¹æ¡†è‰² */
            --success: #52C41A; /* æˆåŠŸè‰² */
            --camera: #4096ff; /* é•œå¤´è‰² æµ…è“ */
            --dialogue: #722ed1; /* å°è¯è‰² ç´« */
            --music: #fa8c16; /* éŸ³ä¹è‰² æ©™é»„ */
            --radius: 12px; /* ç»Ÿä¸€åœ†è§’ */
            --shadow: 0 4px 12px rgba(255, 140, 56, 0.15); /* æš–è‰²è°ƒé˜´å½± */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
        }

        body {
            background-color: #FFF9F5; /* æš–ç™½åº•è‰² */
            max-width: 800px;
            margin: 0 auto;
            padding: 30px 20px;
            color: var(--text-main);
        }

        .app-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .app-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
        }

        .card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .form-item {
            margin-bottom: 20px;
        }

        .label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-main);
            font-size: 15px;
        }

        .hint {
            font-size: 12px;
            color: var(--text-hint);
            margin-top: 4px;
            display: block;
        }

        select, textarea, input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 16px;
            color: var(--text-main);
            background-color: white;
            transition: border 0.3s ease;
        }

        select:focus, textarea:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 140, 56, 0.2);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.6;
        }

        /* åœºæ™¯å¡ç‰‡é€‰æ‹©å™¨æ ·å¼ */
        .scene-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .scene-card {
            padding: 16px 20px;
            background-color: white;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 14px;
            color: var(--text-main);
            position: relative;
            overflow: hidden;
        }

        .scene-card:hover {
            border-color: var(--primary);
            background-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 140, 56, 0.2);
        }

        .scene-card.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 6px 16px rgba(255, 140, 56, 0.35);
            transform: scale(1.02);
        }

        .scene-card.active::after {
            content: "âœ“";
            position: absolute;
            top: 4px;
            right: 8px;
            font-size: 12px;
            font-weight: bold;
        }

        .scene-icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-row .form-item {
            flex: 1;
            margin-bottom: 0;
        }

        .generate-btn {
            width: 100%;
            padding: 14px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .generate-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 140, 56, 0.25);
        }

        .generate-btn:disabled {
            background-color: var(--primary-light);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .btn-history {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #6f42c1, #5a32a3);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-history:hover {
            background: linear-gradient(135deg, #5a32a3, #4a278a);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(111, 66, 193, 0.3);
        }

        .result-card {
            position: relative;
            min-height: 300px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px dashed var(--border);
        }

        .result-title {
            font-weight: 600;
            color: var(--primary);
        }

        .copy-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: color 0.3s ease;
        }

        .copy-btn:hover {
            color: var(--primary-dark);
        }

        /* è„šæœ¬æ ·å¼æ ¸å¿ƒä¼˜åŒ– */
        .result-content {
            font-size: 16px;
            line-height: 1.8;
            color: var(--text-main);
            height: calc(100% - 40px);
            overflow-y: auto;
            padding-right: 10px;
        }

        .script-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary);
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-light);
        }

        .music-suggestion {
            background-color: #FFF5EB;
            border-left: 4px solid var(--music);
            padding: 12px 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            color: var(--music);
        }

        .music-suggestion-label {
            font-weight: 600;
            margin-right: 8px;
        }

        .shot-item {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #FFF5EB;
            border-radius: 8px;
            border-left: 4px solid var(--camera);
        }

        .shot-num {
            font-weight: 600;
            color: var(--camera);
            margin-bottom: 8px;
            font-size: 18px;
        }

        .shot-label {
            font-weight: 600;
            display: inline-block;
            width: 60px;
        }

        .shot-camera {
            color: var(--camera);
            margin-bottom: 5px;
        }

        .shot-dialogue {
            color: var(--dialogue);
            margin-bottom: 5px;
        }

        .shot-music {
            color: var(--music);
            background-color: rgba(250, 140, 22, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .empty-hint {
            color: var(--text-hint);
            font-style: italic;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 160px;
            color: var(--text-hint);
        }

        .loading-dots {
            display: flex;
            gap: 4px;
            margin-top: 12px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--primary-light);
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .success-toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--success);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 999;
        }

        .success-toast.show {
            opacity: 1;
        }

        /* å†å²è®°å½•å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--text-hint);
            cursor: pointer;
            transition: color 0.3s ease;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-main);
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .history-item {
            background-color: #FFF9F5;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            box-shadow: 0 4px 12px rgba(255, 140, 56, 0.15);
            transform: translateY(-2px);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-scene {
            font-weight: 600;
            color: var(--primary);
            font-size: 16px;
        }

        .history-time {
            font-size: 12px;
            color: var(--text-hint);
        }

        .history-info {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .history-actions {
            display: flex;
            gap: 8px;
        }

        .history-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-btn-view {
            background-color: var(--primary);
            color: white;
        }

        .history-btn-view:hover {
            background-color: var(--primary-dark);
        }

        .history-btn-delete {
            background-color: #ff4d4f;
            color: white;
        }

        .history-btn-delete:hover {
            background-color: #d9363e;
        }

        .empty-history {
            text-align: center;
            color: var(--text-hint);
            padding: 40px 20px;
        }

        /* å¤šæ–¹æ¡ˆå¡ç‰‡æ»‘åŠ¨æ ·å¼ - æ ¸å¿ƒä¿®å¤ï¼šåŠ¨æ€å±…ä¸­ + è‡ªé€‚åº” */
        .schemes-container {
            position: relative;
            overflow: hidden;
            padding: 20px 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .schemes-wrapper {
            display: flex;
            align-items: center;
            transition: transform 0.4s ease;
            padding: 10px 0;
            min-height: 420px;
            position: relative;
            width: 100%;
            /* å…³é”®ï¼šåˆå§‹ä½ç½®é‡ç½® */
            left: 0;
            transform: translateX(0);
        }

        .scheme-card {
            flex-shrink: 0;
            /* å…³é”®ï¼šæ”¹ä¸ºç›¸å¯¹å®½åº¦ï¼Œé€‚é…ä¸åŒå±å¹• */
            width: calc(100% - 40px);
            max-width: 600px;
            min-height: 400px;
            background: white;
            border-radius: var(--radius);
            padding: 40px 24px 24px 24px;
            box-shadow: var(--shadow);
            border: 2px solid var(--border);
            transition: all 0.4s ease;
            /* å…³é”®ï¼šç§»é™¤å›ºå®šmarginï¼Œæ”¹ä¸ºåŠ¨æ€é—´è· */
            margin: 0 10px;
            position: relative;
            overflow-y: visible;
        }

        .scheme-card.active {
            border-color: var(--primary);
            box-shadow: 0 8px 24px rgba(255, 140, 56, 0.3);
            transform: scale(1);
            z-index: 10;
            opacity: 1;
            filter: blur(0);
        }

        .scheme-card.inactive {
            opacity: 0.45;
            filter: blur(3px);
            transform: scale(0.88);
            z-index: 1;
        }

        .scheme-card.hidden {
            display: none;
        }

        .scheme-label {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--camera) 0%, #1890ff 100%);
            color: white;
            padding: 8px 24px;
            border-radius: 20px;
            font-size: 20px;
            font-weight: 700;
            z-index: 11;
            box-shadow: 0 4px 12px rgba(64, 150, 255, 0.35);
        }

        .scheme-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #ffffff 0%, #fff9f5 100%);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 20;
            font-size: 24px;
            color: var(--primary);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .scheme-nav.prev {
            left: 10px;
        }

        .scheme-nav.next {
            right: 10px;
        }

        .scheme-nav:hover {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 140, 56, 0.4);
        }

        .scheme-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: translateY(-50%) scale(1);
        }

        .scheme-nav:active {
            transform: translateY(-50%) scale(0.95);
        }

        .scheme-dots {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
        }

        .scheme-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--border);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .scheme-dot.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            transform: scale(1.4);
            box-shadow: 0 4px 12px rgba(255, 140, 56, 0.4);
        }

        .scheme-dot:hover {
            background: var(--primary-dark);
            transform: scale(1.2);
        }

        /* æ”¶è—æŒ‰é’®æ ·å¼ */
        .favorite-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            z-index: 12;
        }

        .favorite-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .favorite-btn.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
            color: white;
        }

        /* æˆ‘çš„æ”¶è—æŒ‰é’®æ ·å¼ */
        .btn-favorites {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-favorites:hover {
            background: linear-gradient(135deg, #ee5a5a 0%, #d94444 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(238, 90, 90, 0.3);
        }

        /* æ”¶è—å¼¹çª—æ ·å¼ */
        .favorites-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2500;
        }

        .favorites-modal.show {
            display: flex;
        }

        .favorites-content {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .favorites-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .favorites-title {
            font-size: 22px;
            font-weight: 700;
            color: #ff6b6b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .favorite-item {
            background-color: #FFF9F5;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .favorite-item:hover {
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.15);
            transform: translateY(-2px);
        }

        .favorite-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .favorite-item-scene {
            font-weight: 600;
            color: var(--primary);
            font-size: 14px;
        }

        .favorite-item-time {
            font-size: 12px;
            color: var(--text-hint);
        }

        .favorite-item-info {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .favorite-item-actions {
            display: flex;
            gap: 8px;
        }

        .favorite-btn-view {
            padding: 6px 12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .favorite-btn-view:hover {
            background-color: var(--primary-dark);
        }

        .favorite-btn-delete {
            padding: 6px 12px;
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .favorite-btn-delete:hover {
            background-color: #ee5a5a;
        }

        .empty-favorites {
            text-align: center;
            color: var(--text-hint);
            padding: 40px 20px;
        }

        /* æ–°ç‰ˆæœ¬æç¤ºå¼¹çª—æ ·å¼ */
        #newVersionModal .update-content {
            max-width: 450px;
        }

        .new-version-info {
            text-align: center;
            padding: 20px 0;
        }

        .new-version-info p {
            margin: 10px 0;
            font-size: 16px;
        }

        .new-version-info strong {
            color: var(--text-secondary);
        }

        .new-version-info span {
            color: var(--primary);
            font-weight: 700;
        }

        .update-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-primary, .btn-secondary {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, #ff8e53 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 107, 107, 0.3);
        }

        .btn-secondary {
            background-color: var(--bg-light);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background-color: var(--border);
        }

        /* ç”¨æˆ·ä¿¡æ¯æ ·å¼ */
        .user-info {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 15px;
            gap: 10px;
        }

        .user-name {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .user-name span {
            font-weight: 600;
            color: var(--primary);
        }

        .btn-edit-name {
            background: none;
            border: none;
            color: var(--text-hint);
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .btn-edit-name:hover {
            background-color: var(--primary-light);
            color: var(--primary);
        }

        /* æ˜µç§°è®¾ç½®å¼¹çª—æ ·å¼ */
        .nickname-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .nickname-modal.show {
            display: flex;
        }

        .nickname-content {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .nickname-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .nickname-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 16px;
            margin-bottom: 20px;
            transition: border 0.3s ease;
        }

        .nickname-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .nickname-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nickname-btn:hover {
            background-color: var(--primary-dark);
        }

        /* æ›´æ–°å…¬å‘Šæ ·å¼ */
        .update-notice {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }

        .update-notice-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(255, 140, 56, 0.3);
            transition: all 0.3s ease;
        }

        .update-notice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(255, 140, 56, 0.4);
        }

        .update-notice-btn .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4d4f;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }

        /* æ›´æ–°å…¬å‘Šå¼¹çª— */
        .update-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .update-modal.show {
            display: flex;
        }

        .update-content {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .update-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .update-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .update-close {
            background: none;
            border: none;
            font-size: 40px;
            color: var(--text-hint);
            cursor: pointer;
            transition: all 0.3s ease;
            line-height: 1;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .update-close:hover {
            color: var(--text-main);
            background-color: var(--primary-light);
        }

        .update-version {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .update-item {
            margin-bottom: 25px;
        }

        .update-date {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .update-features {
            list-style: none;
            padding: 0;
        }

        .update-features li {
            padding: 8px 0;
            padding-left: 24px;
            position: relative;
            color: var(--text-main);
        }

        .update-features li:before {
            content: "âœ¨";
            position: absolute;
            left: 0;
        }
    </style>
</head>
<body>
    <!-- æ›´æ–°å…¬å‘ŠæŒ‰é’® -->
    <div class="update-notice">
        <button class="update-notice-btn" onclick="showUpdateModal()">
            ğŸ“
            <span class="badge">NEW</span>
        </button>
    </div>

    <div class="app-header">
        <h1 class="app-title">AIæ‹</h1>
        <p class="app-subtitle">ä¸€é”®ç”Ÿæˆé«˜è½¬åŒ–çŸ­è§†é¢‘è„šæœ¬ä¸è¥é”€æ–‡æ¡ˆ</p>
    </div>

    <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
    <div class="user-info" id="userInfo">
        <div class="user-name">
            ğŸ‘¤ <span id="userNameDisplay">æ¸¸å®¢</span>
        </div>
        <button class="btn-edit-name" onclick="showNicknameModal()">ä¿®æ”¹æ˜µç§°</button>
    </div>

    <div class="card">
        <div class="form-item">
            <label class="label">åˆ›ä½œåœºæ™¯</label>
            <div class="scene-selector" id="sceneSelector">
                <div class="scene-card" data-value="é¤é¥®çŸ­è§†é¢‘è„šæœ¬">
                    <span class="scene-icon">ğŸœ</span>
                    é¤é¥®æ¢åº—Â·çŸ­è§†é¢‘è„šæœ¬
                </div>
                <div class="scene-card" data-value="ç¾ä¸šé—¨åº—çŸ­è§†é¢‘">
                    <span class="scene-icon">ğŸ’…</span>
                    ç¾ä¸šç¾ç”²Â·é—¨åº—æ¨å¹¿
                </div>
                <div class="scene-card" data-value="è·¨å¢ƒç”µå•†ç¤¾åª’æ–‡æ¡ˆ">
                    <span class="scene-icon">ğŸ›’</span>
                    è·¨å¢ƒç”µå•†Â·ç¤¾åª’ç§è‰
                </div>
                <div class="scene-card" data-value="çŸ¥è¯†åšä¸»å£æ’­è„šæœ¬">
                    <span class="scene-icon">ğŸ“š</span>
                    çŸ¥è¯†åšä¸»Â·å¹²è´§å£æ’­
                </div>
                <div class="scene-card" data-value="æœ¬åœ°ç”Ÿæ´»å›¢è´­æ–‡æ¡ˆ">
                    <span class="scene-icon">ğŸ«</span>
                    æœ¬åœ°ç”Ÿæ´»Â·å›¢è´­å¥—é¤
                </div>
                <div class="scene-card" data-value="æ–‡æ—…æ¢åº—çŸ­è§†é¢‘">
                    <span class="scene-icon">ğŸ›ï¸</span>
                    æ–‡æ—…æ¢åº—Â·æ™¯ç‚¹è®²è§£
                </div>
            </div>
            <input type="hidden" id="scene" value="é¤é¥®çŸ­è§†é¢‘è„šæœ¬">
        </div>

        <!-- æ–°å¢ï¼šé£æ ¼é€‰æ‹© + è§†é¢‘æ—¶é•¿ -->
        <div class="form-row">
            <div class="form-item">
                <label class="label">åˆ›ä½œé£æ ¼</label>
                <select id="style">
                    <option value="å£è¯­åŒ–">å£è¯­åŒ–ï¼ˆé»˜è®¤ï¼‰</option>
                    <option value="ä¸“ä¸šåŒ–">ä¸“ä¸šåŒ–</option>
                    <option value="æç¬‘é£">æç¬‘é£</option>
                    <option value="ç…½æƒ…é£">ç…½æƒ…é£</option>
                </select>
            </div>
            <div class="form-item">
                <label class="label">è§†é¢‘æ—¶é•¿</label>
                <select id="duration">
                    <option value="15ç§’" selected>15ç§’ï¼ˆé»˜è®¤ï¼‰</option>
                    <option value="30ç§’">30ç§’</option>
                    <option value="60ç§’">60ç§’</option>
                </select>
            </div>
        </div>

        <div class="form-item">
            <label class="label">æ ¸å¿ƒå–ç‚¹</label>
            <textarea id="keyInfo" placeholder="è¯·è¯¦ç»†æè¿°äº§å“/æœåŠ¡çš„æ ¸å¿ƒä¼˜åŠ¿ã€ä»·æ ¼ã€æ´»åŠ¨ã€ç›®æ ‡äººç¾¤ç­‰ï¼Œè¶Šå…·ä½“ç”Ÿæˆæ•ˆæœè¶Šå¥½ï¼"></textarea>
            <span class="hint">ç¤ºä¾‹ï¼šå¢æµ®å®«è®²è§£5åˆ†é’Ÿå¿«é€Ÿäº†è§£é•‡é¦†ä¸‰å®ï¼Œé€‚åˆæ—…æ¸¸åšä¸»å£æ’­</span>
        </div>

        <button class="generate-btn" onclick="generateScript()">
            <span>ç”Ÿæˆæ–‡æ¡ˆ</span>
        </button>

        <div class="btn-group">
            <button class="btn-history" onclick="showHistory()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                å†å²è®°å½•
            </button>
            <button class="btn-favorites" onclick="showFavorites()">
                â¤ï¸
                æˆ‘çš„æ”¶è—
            </button>
        </div>
    </div>

    <div class="card result-card">
        <div class="result-header">
            <h3 class="result-title">ç”Ÿæˆç»“æœ</h3>
            <button class="copy-btn" onclick="copyResult()" id="copyBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                å¤åˆ¶æ–‡æ¡ˆ
            </button>
        </div>
        <div class="schemes-container">
            <button class="scheme-nav prev" onclick="prevScheme()" id="prevBtn" disabled>
                &#8249;
            </button>
            <div class="schemes-wrapper" id="schemesWrapper">
                <div class="scheme-card active" id="singleResult">
                    <div class="result-content" id="result">
                        ç‚¹å‡»ä¸Šæ–¹ã€Œç”Ÿæˆæ–‡æ¡ˆã€æŒ‰é’®ï¼Œä¼˜è´¨è„šæœ¬å°†åœ¨æ­¤å‘ˆç°...
                    </div>
                </div>
            </div>
            <button class="scheme-nav next" onclick="nextScheme()" id="nextBtn" disabled>
                &#8250;
            </button>
        </div>
        <div class="scheme-dots" id="schemeDots"></div>
    </div>

    <div class="success-toast" id="toast">å¤åˆ¶æˆåŠŸï¼</div>

    <!-- å†å²è®°å½•å¼¹çª— -->
    <div class="modal-overlay" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">å†å²è®°å½•</h3>
                <button class="modal-close" onclick="closeHistory()">&times;</button>
            </div>
            <div class="modal-body" id="historyList">
                <!-- å†å²è®°å½•åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- æ˜µç§°è®¾ç½®å¼¹çª— -->
    <div class="nickname-modal" id="nicknameModal">
        <div class="nickname-content">
            <h3 class="nickname-title">è®¾ç½®ä½ çš„æ˜µç§°</h3>
            <input type="text" class="nickname-input" id="nicknameInput" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°">
            <button class="nickname-btn" onclick="saveNickname()">ä¿å­˜</button>
        </div>
    </div>

    <!-- æˆ‘çš„æ”¶è—å¼¹çª— -->
    <div class="favorites-modal" id="favoritesModal">
        <div class="favorites-content">
            <div class="favorites-header">
                <div class="favorites-title">
                    â¤ï¸ æˆ‘çš„æ”¶è—
                </div>
                <button class="update-close" onclick="closeFavorites()">&times;</button>
            </div>
            <div id="favoritesList">
                <div class="empty-favorites">
                    è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•æ–‡æ¡ˆï¼Œå¿«å»æ”¶è—å§ï¼
                </div>
            </div>
        </div>
    </div>

    <!-- æ›´æ–°å…¬å‘Šå¼¹çª— -->
    <div class="update-modal" id="updateModal">
        <div class="update-content">
            <div class="update-header">
                <div class="update-title">
                    ğŸš€ æ›´æ–°å…¬å‘Š
                    <span class="update-version">AIæ‹ 1.0</span>
                </div>
                <button class="update-close" onclick="closeUpdateModal()">&times;</button>
            </div>
            
            <div class="update-item">
                <div class="update-date">ğŸ“… 2026å¹´2æœˆ22æ—¥ - é¦–æ¬¡å‘å¸ƒ</div>
                <ul class="update-features">
                    <li>æ”¯æŒé¤é¥®ã€ç¾ä¸šã€è·¨å¢ƒç”µå•†ç­‰6å¤§åœºæ™¯ã€4å¤§åˆ›ä½œé£æ ¼</li>
                    <li>3ç§æ–¹æ¡ˆä¸€é”®ç”Ÿæˆï¼Œçµæ´»é€‰æ‹©</li>
                    <li>AIè‡ªåŠ¨ç”Ÿæˆåœºæ™¯ä¸“å±è¯­æ–™åº“ï¼Œæ— éœ€æ‰‹åŠ¨ä¸Šä¼ </li>
                    <li>å†å²è®°å½•ã€æ”¶è—åŠŸèƒ½ï¼Œéšæ—¶æŸ¥çœ‹ä¹‹å‰çš„æ–‡æ¡ˆ</li>
                    <li>ç”¨æˆ·æ˜µç§°è®¾ç½®ï¼Œæ•°æ®æ°¸ä¹…ä¿å­˜åœ¨æœ¬åœ°</li>
                    <li>æ”¯æŒ15ç§’ã€30ç§’ã€60ç§’ä¸‰ç§è§†é¢‘æ—¶é•¿</li>
                    <li>ä¸€é”®å¤åˆ¶åŠŸèƒ½ï¼Œæ–¹ä¾¿å¿«æ·</li>
                    <li>ç²¾ç¾å¡ç‰‡å¼è®¾è®¡ï¼Œå·¦å³æ»‘åŠ¨åˆ‡æ¢æ–¹æ¡ˆ</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- æ–°ç‰ˆæœ¬æç¤ºå¼¹çª— -->
    <div class="update-modal" id="newVersionModal">
        <div class="update-content">
            <div class="update-header">
                <div class="update-title">
                    ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬ï¼
                </div>
                <button class="update-close" onclick="closeNewVersionModal()">&times;</button>
            </div>
            
            <div class="update-item">
                <div class="new-version-info">
                    <p><strong>å½“å‰ç‰ˆæœ¬ï¼š</strong> <span id="currentVersionDisplay"></span></p>
                    <p><strong>æœ€æ–°ç‰ˆæœ¬ï¼š</strong> <span id="latestVersionDisplay"></span></p>
                </div>
                <div class="update-buttons">
                    <button class="btn-primary" onclick="goToDownload()">å»ä¸‹è½½</button>
                    <button class="btn-secondary" onclick="closeNewVersionModal()">ç¨åå†è¯´</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "/api/script/create";
        // ç‰ˆæœ¬ä¿¡æ¯
        const APP_VERSION = "1.0.0";
        const GITHUB_REPO = "Meng-p7/ai_copywriter"; // è®°å¾—æ”¹æˆä½ çš„ GitHub ç”¨æˆ·å
        
        // ç”¨æˆ·ä¿¡æ¯ï¼ˆå•æœºç‰ˆç”¨å›ºå®šIDï¼‰
        let USER_ID = "local_user_fixed_id_2026";
        let userName = "";
        
        // å½“å‰ç”Ÿæˆçš„æ–‡æ¡ˆä¿¡æ¯
        let currentScriptInfo = null;
        
        // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
        function initUser() {
            const savedUserName = localStorage.getItem('ai_copywriter_user_name');
            
            if (savedUserName) {
                userName = savedUserName;
                document.getElementById('userNameDisplay').textContent = userName;
            } else {
                userName = "åˆ›ä½œè€…";
                document.getElementById('userNameDisplay').textContent = userName;
            }
        }

        // æ£€æŸ¥æ›´æ–°
        async function checkForUpdates() {
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/releases/latest`);
                if (!response.ok) return;
                
                const data = await response.json();
                const latestVersion = data.tag_name.replace('v', '');
                
                if (isNewerVersion(latestVersion, APP_VERSION)) {
                    showNewVersionModal(APP_VERSION, latestVersion);
                }
            } catch (e) {
                console.log('æ£€æŸ¥æ›´æ–°å¤±è´¥:', e);
            }
        }

        // æ¯”è¾ƒç‰ˆæœ¬å·
        function isNewerVersion(latest, current) {
            const latestParts = latest.split('.').map(Number);
            const currentParts = current.split('.').map(Number);
            
            for (let i = 0; i < Math.max(latestParts.length, currentParts.length); i++) {
                const l = latestParts[i] || 0;
                const c = currentParts[i] || 0;
                if (l > c) return true;
                if (l < c) return false;
            }
            return false;
        }

        // æ˜¾ç¤ºæ–°ç‰ˆæœ¬æç¤º
        function showNewVersionModal(current, latest) {
            document.getElementById('currentVersionDisplay').textContent = 'v' + current;
            document.getElementById('latestVersionDisplay').textContent = 'v' + latest;
            document.getElementById('newVersionModal').classList.add('show');
        }

        // å…³é—­æ–°ç‰ˆæœ¬æç¤º
        function closeNewVersionModal() {
            document.getElementById('newVersionModal').classList.remove('show');
        }

        // è·³è½¬åˆ°ä¸‹è½½é¡µé¢
        function goToDownload() {
            window.open(`https://github.com/${GITHUB_REPO}/releases/latest`, '_blank');
        }
        
        // æ˜¾ç¤ºæ˜µç§°è®¾ç½®å¼¹çª—
        function showNicknameModal() {
            const modal = document.getElementById('nicknameModal');
            const input = document.getElementById('nicknameInput');
            input.value = userName;
            modal.classList.add('show');
            input.focus();
        }
        
        // ä¿å­˜æ˜µç§°
        function saveNickname() {
            const input = document.getElementById('nicknameInput');
            const newName = input.value.trim();
            
            if (!newName) {
                alert('è¯·è¾“å…¥æ˜µç§°');
                return;
            }
            
            userName = newName;
            localStorage.setItem('ai_copywriter_user_name', userName);
            document.getElementById('userNameDisplay').textContent = userName;
            document.getElementById('nicknameModal').classList.remove('show');
        }
        
        // ä¿å­˜åŸå§‹æ–‡æœ¬ï¼ˆç”¨äºå¤åˆ¶ï¼‰
        let originalScript = "";
        // ä¿å­˜æ‰€æœ‰æ–¹æ¡ˆ
        let allSchemes = [];
        // å½“å‰é€‰ä¸­çš„æ–¹æ¡ˆç´¢å¼•
        let currentSchemeIndex = 0;

        // åˆå§‹åŒ–ç”¨æˆ·
        initUser();

        // æ˜¾ç¤ºæ›´æ–°å…¬å‘Š
        function showUpdateModal() {
            document.getElementById('updateModal').classList.add('show');
        }

        // å…³é—­æ›´æ–°å…¬å‘Š
        function closeUpdateModal() {
            document.getElementById('updateModal').classList.remove('show');
        }

        // æ¯æ¬¡æ‰“å¼€éƒ½å¼¹å‡ºæ›´æ–°å…¬å‘Š
        setTimeout(() => {
            showUpdateModal();
        }, 500);

        // å½“å‰æ”¶è—åˆ—è¡¨ç¼“å­˜
        let currentFavorites = [];

        // è·å–æ”¶è—åˆ—è¡¨ï¼ˆä»æ•°æ®åº“ï¼‰
        async function loadFavorites() {
            try {
                const response = await fetch(`/api/favorites/list?user_id=${USER_ID}`);
                const data = await response.json();
                if (data.code === 200) {
                    currentFavorites = data.data || [];
                    return currentFavorites;
                }
                return [];
            } catch (e) {
                console.error(e);
                return [];
            }
        }

        // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
        async function checkFavorite(schemeIndex) {
            if (!currentScriptInfo) return false;
            await loadFavorites();
            const schemeName = `æ–¹æ¡ˆ${schemeIndex + 1}`;
            return currentFavorites.some(f => 
                f.scene === currentScriptInfo.scene && 
                f.scheme_name === schemeName &&
                f.content === currentScriptInfo.schemes[schemeIndex]
            );
        }

        // åˆ‡æ¢æ”¶è—çŠ¶æ€
        async function toggleFavorite(schemeIndex) {
            if (!currentScriptInfo) {
                alert('è¯·å…ˆç”Ÿæˆæ–‡æ¡ˆï¼');
                return;
            }

            const schemeName = `æ–¹æ¡ˆ${schemeIndex + 1}`;
            const content = currentScriptInfo.schemes[schemeIndex];
            
            await loadFavorites();
            const existing = currentFavorites.find(f => 
                f.scene === currentScriptInfo.scene && 
                f.scheme_name === schemeName &&
                f.content === content
            );

            if (existing) {
                // å–æ¶ˆæ”¶è—
                try {
                    await fetch(`/api/favorites/${existing.id}?user_id=${USER_ID}`, {
                        method: 'DELETE'
                    });
                    const btn = document.querySelector(`.scheme-card[data-index="${schemeIndex}"] .favorite-btn`);
                    if (btn) {
                        btn.classList.remove('active');
                        btn.innerHTML = 'ğŸ¤';
                    }
                    showToast('å·²å–æ¶ˆæ”¶è—');
                } catch (e) {
                    console.error(e);
                    showToast('å–æ¶ˆæ”¶è—å¤±è´¥');
                }
            } else {
                // æ·»åŠ æ”¶è—
                try {
                    const params = new URLSearchParams({
                        user_id: USER_ID,
                        scene: currentScriptInfo.scene,
                        style: currentScriptInfo.style,
                        duration: currentScriptInfo.duration,
                        key_info: currentScriptInfo.keyInfo,
                        content: content,
                        scheme_index: schemeIndex,
                        scheme_name: schemeName
                    });
                    await fetch(`/api/favorites/add?${params}`, {
                        method: 'POST'
                    });
                    const btn = document.querySelector(`.scheme-card[data-index="${schemeIndex}"] .favorite-btn`);
                    if (btn) {
                        btn.classList.add('active');
                        btn.innerHTML = 'â¤ï¸';
                    }
                    showToast('æ”¶è—æˆåŠŸï¼');
                } catch (e) {
                    console.error(e);
                    showToast('æ”¶è—å¤±è´¥');
                }
            }
        }

        // æ˜¾ç¤ºæ”¶è—åˆ—è¡¨
        async function showFavorites() {
            const modal = document.getElementById('favoritesModal');
            const list = document.getElementById('favoritesList');
            
            list.innerHTML = '<div class="empty-favorites">åŠ è½½ä¸­...</div>';
            modal.classList.add('show');
            
            const favorites = await loadFavorites();

            if (favorites.length === 0) {
                list.innerHTML = '<div class="empty-favorites">è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•æ–‡æ¡ˆï¼Œå¿«å»æ”¶è—å§ï¼</div>';
            } else {
                list.innerHTML = favorites.map((fav, index) => `
                    <div class="favorite-item" data-id="${fav.id}">
                        <div class="favorite-item-header">
                            <div class="favorite-item-scene">${fav.scene} - ${fav.scheme_name || 'æ–¹æ¡ˆ'}</div>
                            <div class="favorite-item-time">${fav.create_time}</div>
                        </div>
                        <div class="favorite-item-info">
                            æ—¶é•¿ï¼š${fav.duration} | é£æ ¼ï¼š${fav.style}
                        </div>
                        <div class="favorite-item-actions">
                            <button class="favorite-btn-view" onclick="viewFavorite(${index})">æŸ¥çœ‹</button>
                            <button class="favorite-btn-delete" onclick="deleteFavorite('${fav.id}')">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        // å…³é—­æ”¶è—å¼¹çª—
        function closeFavorites() {
            document.getElementById('favoritesModal').classList.remove('show');
        }

        // æŸ¥çœ‹æ”¶è—å†…å®¹
        async function viewFavorite(index) {
            const favorites = await loadFavorites();
            const fav = favorites[index];
            if (fav) {
                // åªæ˜¾ç¤ºæ”¶è—çš„é‚£ä¸€ä¸ªæ–¹æ¡ˆ
                allSchemes = [fav.content];
                originalScript = fav.content;
                currentSchemeIndex = 0;
                
                // ä¿å­˜currentScriptInfo
                currentScriptInfo = {
                    scene: fav.scene,
                    style: fav.style,
                    duration: fav.duration,
                    keyInfo: fav.key_info,
                    schemes: allSchemes,
                    time: fav.create_time
                };
                
                renderSchemes();
                closeFavorites();
                
                // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                document.querySelector('.result-card').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // åˆ é™¤æ”¶è—
        async function deleteFavorite(favoriteId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ”¶è—å—ï¼Ÿ')) {
                try {
                    await fetch(`/api/favorites/${favoriteId}?user_id=${USER_ID}`, {
                        method: 'DELETE'
                    });
                    showFavorites();
                    showToast('å·²åˆ é™¤');
                } catch (e) {
                    console.error(e);
                    showToast('åˆ é™¤å¤±è´¥');
                }
            }
        }

        // åœºæ™¯å¡ç‰‡é€‰æ‹©å™¨é€»è¾‘
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
            initUser();
            
            // æ£€æŸ¥æ›´æ–°
            setTimeout(() => {
                checkForUpdates();
            }, 1000);
            
            // æŒ‰Enteré”®ä¿å­˜æ˜µç§°
            const nicknameInput = document.getElementById('nicknameInput');
            if (nicknameInput) {
                nicknameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        saveNickname();
                    }
                });
            }
            
            const sceneCards = document.querySelectorAll('.scene-card');
            const sceneInput = document.getElementById('scene');

            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå¡ç‰‡
            if (sceneCards.length > 0) {
                sceneCards[0].classList.add('active');
            }

            sceneCards.forEach(card => {
                card.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰å¡ç‰‡çš„activeçŠ¶æ€
                    sceneCards.forEach(c => c.classList.remove('active'));
                    // ç»™å½“å‰ç‚¹å‡»çš„å¡ç‰‡æ·»åŠ activeçŠ¶æ€
                    this.classList.add('active');
                    // æ›´æ–°éšè—inputçš„å€¼
                    sceneInput.value = this.getAttribute('data-value');
                });
            });
        });

        async function generateScript() {
            const scene = document.getElementById("scene").value;
            const style = document.getElementById("style").value;
            const duration = document.getElementById("duration").value;
            const keyInfo = document.getElementById("keyInfo").value.trim();
            const schemesWrapper = document.getElementById("schemesWrapper");
            const btn = document.querySelector(".generate-btn");

            if (!keyInfo) {
                alert("è¯·å¡«å†™æ ¸å¿ƒå–ç‚¹ï¼Œä¿¡æ¯è¶Šè¯¦ç»†ç”Ÿæˆæ•ˆæœè¶Šå¥½ï¼");
                return;
            }

            // åŠ è½½çŠ¶æ€
            btn.disabled = true;
            btn.innerHTML = '<span>ç”Ÿæˆä¸­...</span>';
            schemesWrapper.innerHTML = `
                <div class="scheme-card active">
                    <div class="loading">
                        <span>AIæ­£åœ¨ä¸ºä½ æ„æ€å¤šç§æ–¹æ¡ˆ...</span>
                        <div class="loading-dots">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById("schemeDots").innerHTML = "";
            document.getElementById("prevBtn").disabled = true;
            document.getElementById("nextBtn").disabled = true;

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        user_id: USER_ID,
                        scene: scene,
                        style: style,
                        duration: duration,
                        key_info: keyInfo
                    })
                });

                const data = await response.json();
                if (data.code === 200) {
                    allSchemes = data.data.schemes || [data.data.content];
                    originalScript = allSchemes[0];
                    currentSchemeIndex = 0;
                    
                    // ä¿å­˜å½“å‰ç”Ÿæˆçš„æ–‡æ¡ˆä¿¡æ¯
                    currentScriptInfo = {
                        scene: scene,
                        style: style,
                        duration: duration,
                        keyInfo: keyInfo,
                        schemes: allSchemes,
                        time: new Date().toLocaleString('zh-CN')
                    };
                    
                    renderSchemes();
                } else {
                    allSchemes = [];
                    originalScript = "";
                    currentScriptInfo = null;
                    schemesWrapper.innerHTML = `
                        <div class="scheme-card active">
                            <div class="result-content">ç”Ÿæˆå¤±è´¥ï¼š${data.msg || "æœåŠ¡å™¨ç¹å¿™ï¼Œè¯·ç¨åå†è¯•"}</div>
                        </div>
                    `;
                }
            } catch (e) {
                allSchemes = [];
                originalScript = "";
                schemesWrapper.innerHTML = `
                    <div class="scheme-card active">
                        <div class="result-content">è¯·æ±‚å¤±è´¥ï¼šè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</div>
                    </div>
                `;
                console.error(e);
            } finally {
                // æ¢å¤çŠ¶æ€
                btn.disabled = false;
                btn.innerHTML = '<span>ç”Ÿæˆæ–‡æ¡ˆ</span>';
            }
        }

        // æ¸²æŸ“æ‰€æœ‰æ–¹æ¡ˆ
        async function renderSchemes() {
            const schemesWrapper = document.getElementById("schemesWrapper");
            const schemeDots = document.getElementById("schemeDots");

            schemesWrapper.innerHTML = "";
            schemeDots.innerHTML = "";

            // å…ˆåŠ è½½æ”¶è—çŠ¶æ€
            const favorites = await loadFavorites();

            allSchemes.forEach((scheme, index) => {
                const schemeName = `æ–¹æ¡ˆ${index + 1}`;
                const isFavorited = currentScriptInfo && favorites.some(f => 
                    f.scene === currentScriptInfo.scene && 
                    f.scheme_name === schemeName &&
                    f.content === scheme
                );
                
                // åˆ›å»ºæ–¹æ¡ˆå¡ç‰‡
                const card = document.createElement("div");
                card.className = "scheme-card" + (index === currentSchemeIndex ? " active" : " inactive");
                card.dataset.index = index;
                
                // å¦‚æœåªæœ‰ä¸€ä¸ªæ–¹æ¡ˆï¼ˆæ”¶è—çš„ï¼‰ï¼Œæ ‡ç­¾æ˜¾ç¤º"å·²æ”¶è—"
                const labelText = allSchemes.length === 1 ? "å·²æ”¶è—" : `æ–¹æ¡ˆ ${index + 1}`;
                
                card.innerHTML = `
                    <button class="favorite-btn ${isFavorited ? 'active' : ''}" onclick="toggleFavorite(${index})">
                        ${isFavorited ? 'â¤ï¸' : 'ğŸ¤'}
                    </button>
                    <div class="scheme-label">${labelText}</div>
                    <div class="result-content">${formatScript(scheme)}</div>
                `;
                schemesWrapper.appendChild(card);

                // åˆ›å»ºæ–¹æ¡ˆæŒ‡ç¤ºç‚¹ï¼ˆåªæœ‰ä¸€ä¸ªæ–¹æ¡ˆæ—¶ä¸æ˜¾ç¤ºï¼‰
                if (allSchemes.length > 1) {
                    const dot = document.createElement("div");
                    dot.className = "scheme-dot" + (index === currentSchemeIndex ? " active" : "");
                    dot.dataset.index = index;
                    dot.onclick = () => goToScheme(index);
                    schemeDots.appendChild(dot);
                }
            });

            // ç­‰å¾…DOMæ¸²æŸ“åæ›´æ–°
            setTimeout(() => {
                updateSchemeDisplay();
            }, 50);
        }

        // åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªæ–¹æ¡ˆ
        function prevScheme() {
            if (currentSchemeIndex > 0) {
                currentSchemeIndex--;
                updateSchemeDisplay();
            }
        }

        // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ–¹æ¡ˆ
        function nextScheme() {
            if (currentSchemeIndex < allSchemes.length - 1) {
                currentSchemeIndex++;
                updateSchemeDisplay();
            }
        }

        // è·³è½¬åˆ°æŒ‡å®šæ–¹æ¡ˆ
        function goToScheme(index) {
            currentSchemeIndex = index;
            updateSchemeDisplay();
        }

        // æ›´æ–°æ–¹æ¡ˆæ˜¾ç¤º - æ ¸å¿ƒä¿®å¤ï¼šåŠ¨æ€è®¡ç®—å±…ä¸­ä½ç§»
        function updateSchemeDisplay() {
            const cards = document.querySelectorAll(".scheme-card");
            const dots = document.querySelectorAll(".scheme-dot");
            const prevBtn = document.getElementById("prevBtn");
            const nextBtn = document.getElementById("nextBtn");
            const schemesWrapper = document.getElementById("schemesWrapper");
            const container = document.querySelector(".schemes-container");

            // æ›´æ–°å½“å‰é€‰ä¸­çš„æ–¹æ¡ˆæ–‡æœ¬
            originalScript = allSchemes[currentSchemeIndex];

            // æ›´æ–°å¡ç‰‡æ ·å¼
            cards.forEach((card, index) => {
                card.classList.remove("active", "inactive");
                if (index === currentSchemeIndex) {
                    card.classList.add("active");
                } else {
                    card.classList.add("inactive");
                }
            });

            // æ›´æ–°æŒ‡ç¤ºç‚¹
            dots.forEach((dot, index) => {
                dot.classList.remove("active");
                if (index === currentSchemeIndex) {
                    dot.classList.add("active");
                }
            });

            // æ ¸å¿ƒä¿®å¤ï¼šåŠ¨æ€è®¡ç®—ä½ç§»ï¼Œç¡®ä¿å½“å‰å¡ç‰‡å±…ä¸­
            if (cards.length > 0) {
                // è·å–å®¹å™¨å’Œå¡ç‰‡çš„å®é™…å°ºå¯¸
                const containerWidth = container.offsetWidth;
                const cardWidth = cards[0].offsetWidth;
                // è®¡ç®—å•ä¸ªå¡ç‰‡çš„åç§»é‡ï¼ˆå®¹å™¨ä¸­å¿ƒ - å¡ç‰‡ä¸­å¿ƒï¼‰
                const baseOffset = (containerWidth - cardWidth) / 2;
                // è®¡ç®—æ•´ä½“æ»‘åŠ¨ä½ç§»ï¼š-å½“å‰ç´¢å¼•*å¡ç‰‡å®½åº¦ + åŸºç¡€åç§»ï¼ˆæŠµæ¶ˆå¡ç‰‡å·¦ä¾§ç©ºç™½ï¼‰
                const offsetX = - (currentSchemeIndex * (cardWidth + 20)) + baseOffset;
                
                schemesWrapper.style.transform = `translateX(${offsetX}px)`;
            }

            // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            prevBtn.disabled = currentSchemeIndex === 0;
            nextBtn.disabled = currentSchemeIndex === allSchemes.length - 1;
        }

        // æ ¸å¿ƒï¼šæ ¼å¼åŒ–è„šæœ¬ï¼Œç²¾å‡†è§£æé•œå¤´/å°è¯/é…ä¹ï¼Œå…œåº•ç©ºå€¼
        function formatScript(scriptText) {
            // 1. æå–æ ‡é¢˜
            const titleMatch = scriptText.match(/æ ‡é¢˜[:ï¼š]\s*(.+)/);
            const title = titleMatch ? titleMatch[1].trim() : "æ— æ ‡é¢˜";
            const rest = scriptText.replace(/æ ‡é¢˜[:ï¼š]\s*.+/, "").trim();

            // 2. æå–ç»Ÿä¸€é…ä¹å»ºè®®
            const musicMatch = rest.match(/é…ä¹å»ºè®®[:ï¼š]\s*(.+)/);
            const music = musicMatch ? musicMatch[1].trim() : "";
            const shotsContent = rest.replace(/é…ä¹å»ºè®®[:ï¼š]\s*.+/, "").trim();

            // 3. æŒ‰é•œå¤´åˆ†ç»„ï¼ˆåŒ¹é…é•œå¤´1ã€é•œå¤´2...ï¼‰
            const shotRegex = /é•œå¤´(\d+)[:ï¼š]\s*(.+?)(?=é•œå¤´\d+[:ï¼š]|$)/gs;
            const matches = [...shotsContent.matchAll(shotRegex)];

            let html = `<div class="script-title">ã€è§†é¢‘æ ‡é¢˜ã€‘${title}</div>`;

            // æ˜¾ç¤ºç»Ÿä¸€é…ä¹å»ºè®®
            if (music) {
                html += `
                    <div class="music-suggestion">
                        <span class="music-suggestion-label">ğŸµ é…ä¹å»ºè®®ï¼š</span>${music}
                    </div>
                `;
            }

            if (matches.length === 0) {
                html += `<div>${shotsContent}</div>`;
                return html;
            }

            matches.forEach(match => {
                const num = match[1];
                let content = match[2].trim();

                // å…œåº•ï¼šå¦‚æœä¸€è¡Œé‡ŒåŒæ—¶å‡ºç°é•œå¤´å’Œå°è¯ï¼Œå°è¯•æ‹†åˆ†
                let camera = "";
                let dialogue = "";

                // å…ˆå°è¯•åŒ¹é…æ ‡å‡†æ ¼å¼
                const dialogueMatch = content.match(/å°è¯(\d+)[:ï¼š]\s*(.+)/);

                if (dialogueMatch) {
                    // æ ‡å‡†æ ¼å¼ï¼šé•œå¤´ã€å°è¯åˆ†ç¦»
                    camera = content.replace(/å°è¯\d+[:ï¼š].+/, "").trim();
                    dialogue = dialogueMatch[2].trim();
                } else {
                    // å…œåº•æ ¼å¼ï¼šå°è¯•ä»ä¸€è¡Œé‡Œæ‹†åˆ†
                    const dialoguePart = content.split(/å°è¯\d+[:ï¼š]/);
                    if (dialoguePart.length > 1) {
                        dialogue = dialoguePart[1].trim();
                        camera = dialoguePart[0].trim();
                    } else {
                        // å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°å°è¯ï¼Œå°±æŠŠæ•´è¡Œå½“ä½œé•œå¤´
                        camera = content;
                        dialogue = '<span class="empty-hint">ï¼ˆå°è¯å¾…è¡¥å……ï¼Œå¯æ ¹æ®é•œå¤´è‡ªç”±å‘æŒ¥ï¼‰</span>';
                    }
                }

                camera = camera || '<span class="empty-hint">ï¼ˆé•œå¤´æè¿°å¾…è¡¥å……ï¼‰</span>';

                html += `
                    <div class="shot-item">
                        <div class="shot-num">é•œå¤´ ${num}</div>
                        <div class="shot-camera"><span class="shot-label">é•œå¤´ï¼š</span>${camera}</div>
                        <div class="shot-dialogue"><span class="shot-label">å°è¯ï¼š</span>${dialogue}</div>
                    </div>
                `;
            });

            return html;
        }

        function copyResult() {
            const toast = document.getElementById("toast");

            if (!originalScript || originalScript.includes("ç‚¹å‡»ä¸Šæ–¹") || originalScript.includes("ç”Ÿæˆå¤±è´¥")) {
                alert("æš‚æ— å¯ç”¨æ–‡æ¡ˆå¯å¤åˆ¶");
                return;
            }

            // å¤åˆ¶åŸå§‹çº¯æ–‡æœ¬ï¼ˆä¸å¸¦æ ·å¼ï¼‰
            navigator.clipboard.writeText(originalScript).then(() => {
                showToast("å¤åˆ¶æˆåŠŸï¼");
            }).catch(() => {
                alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰ä¸­å¤åˆ¶");
            });
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.classList.add("show");
            setTimeout(() => toast.classList.remove("show"), 2000);
        }
        
        // æ˜¾ç¤ºå†å²è®°å½•
        async function showHistory() {
            const modal = document.getElementById("historyModal");
            const historyList = document.getElementById("historyList");

            modal.classList.add("show");

            try {
                const response = await fetch(`/api/scripts/history?user_id=${USER_ID}`);
                const data = await response.json();
                if (data.code === 200 && data.data && data.data.length > 0) {
                    historyList.innerHTML = data.data.map((item, index) => `
                        <div class="history-item" data-index="${index}">
                            <div class="history-header">
                                <span class="history-scene">${item.scene}</span>
                                <span class="history-time">${item.create_time}</span>
                            </div>
                            <div class="history-info">
                                ${item.key_info.length > 50 ? item.key_info.substring(0, 50) + '...' : item.key_info}
                            </div>
                            <div class="history-actions">
                                <button class="history-btn history-btn-view" data-index="${index}">æŸ¥çœ‹</button>
                                <button class="history-btn history-btn-delete" onclick="deleteHistory('${item.id}')">åˆ é™¤</button>
                            </div>
                        </div>
                    `).join('');
                    
                    setTimeout(() => {
                        const viewBtns = historyList.querySelectorAll('.history-btn-view');
                        viewBtns.forEach((btn, idx) => {
                            btn.addEventListener('click', () => {
                                viewHistory(data.data[idx]);
                            });
                        });
                    }, 10);
                } else {
                    historyList.innerHTML = `<div class="empty-history">æš‚æ— å†å²è®°å½•</div>`;
                }
            } catch (e) {
                historyList.innerHTML = `<div class="empty-history">è·å–å†å²è®°å½•å¤±è´¥</div>`;
                console.error(e);
            }
        }

        // æŸ¥çœ‹å†å²è®°å½•
        function viewHistory(item) {
            closeHistory();
            
            // è·å–æ‰€æœ‰æ–¹æ¡ˆ
            allSchemes = item.schemes || [item.content];
            originalScript = allSchemes[0];
            currentSchemeIndex = 0;
            
            // ä¿å­˜åˆ°currentScriptInfoä»¥ä¾¿æ”¶è—åŠŸèƒ½æ­£å¸¸å·¥ä½œ
            currentScriptInfo = {
                scene: item.scene,
                style: item.style,
                duration: item.duration,
                keyInfo: item.key_info,
                schemes: allSchemes,
                time: item.create_time
            };
            
            renderSchemes();
        }

        // åˆ é™¤å†å²è®°å½•
        async function deleteHistory(scriptId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
            try {
                const response = await fetch(`/api/scripts/${scriptId}?user_id=${USER_ID}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (data.code === 200) {
                    showHistory();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥');
                console.error(e);
            }
        }

        // å…³é—­å†å²è®°å½•ï¼ˆè¡¥å……ç¼ºå¤±çš„å‡½æ•°ï¼‰
        function closeHistory() {
            const modal = document.getElementById("historyModal");
            modal.classList.remove("show");
        }

        // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è®¡ç®—å±…ä¸­ï¼ˆé€‚é…å“åº”å¼ï¼‰
        window.addEventListener('resize', updateSchemeDisplay);
    </script>
</body>
</html>